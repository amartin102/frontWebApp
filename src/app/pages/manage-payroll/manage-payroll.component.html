<div class="payroll-container">
  <h2>Gestionar Nómina</h2>

  <p-toast position="top-right"></p-toast>
  <p-confirmDialog header="Confirmación" icon="pi pi-exclamation-triangle"></p-confirmDialog>

  <!-- Sección 1: Gestionar Novedades -->
  <p-card header="Gestionar Novedades" styleClass="mb-4">
    <form [formGroup]="filterForm">
      <div class="grid">
        <!-- Filtro Cliente -->
        <div class="field col-12 md:col-4">
          <label for="client">Cliente *</label>
          <p-dropdown 
            id="client"
            [options]="clients" 
            optionLabel="name" 
            optionValue="id" 
            placeholder="Seleccione cliente"
            formControlName="client"
            [filter]="true"
            appendTo="body"
            styleClass="w-full">
          </p-dropdown>
        </div>

        <!-- Filtro Empleados (Selección múltiple) -->
        <div class="field col-12 md:col-4">
          <label for="employee">Empleados *</label>
          <p-multiSelect 
            id="employee"
            [options]="employees" 
            optionLabel="name" 
            optionValue="id" 
            placeholder="Seleccione empleados"
            formControlName="employee"
            [filter]="true"
            appendTo="body"
            styleClass="w-full"
            [disabled]="!clientControl.value"
            display="chip">
          </p-multiSelect>
        </div>

        <!-- Filtro Período -->
        <div class="field col-12 md:col-4">
          <label for="period">Período Nómina *</label>
          <p-dropdown 
            id="period"
            [options]="periods" 
            optionLabel="descripcion" 
            optionValue="id" 
            placeholder="Seleccione período"
            formControlName="period"
            [filter]="true"
            appendTo="body"
            styleClass="w-full"
            [disabled]="!clientControl.value">
            <ng-template let-period pTemplate="item">
              <div>
                <strong>{{period.identificadorPeriodo}}</strong> - {{period.descripcion}}
                <br>
                <small>{{period.fechaInicio | date:'dd/MM/yyyy'}} - {{period.fechaFin | date:'dd/MM/yyyy'}}</small>
              </div>
            </ng-template>
          </p-dropdown>
        </div>
      </div>

      <div class="flex justify-content-end mt-3">
        <button 
          pButton 
          label="Novedad" 
          icon="pi pi-plus" 
          (click)="openNovedadDialog()"
          [disabled]="!clientControl.value || !employeeControl.value?.length || !periodControl.value">
        </button>
      </div>
    </form>

    <!-- Grid de Empleados con Novedades -->
    <div class="mt-4">
      <p-message 
        *ngIf="!clientControl.value" 
        severity="info" 
        text="Seleccione los filtros para ver novedades de los empleados">
      </p-message>

      <p-table 
        *ngIf="clientControl.value"
        [value]="payrollItems" 
        [loading]="loading"
        styleClass="p-datatable-sm"
        [paginator]="true"
        [rows]="10"
        responsiveLayout="scroll">
        
        <ng-template pTemplate="header">
          <tr>
            <th>Empleado</th>
            <th>Identificación</th>
            <th>Concepto</th>
            <th>Tipo Concepto</th>
            <th>Período</th>
            <th class="text-center">Valor Novedad</th>
            <th class="text-center">Fecha Novedad</th>
            <th style="width: 120px">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{item.empleadoNombre}}</td>
            <td>{{item.empleadoIdentificacion}}</td>
            <td>{{item.conceptoNombre || '-'}}</td>
            <td>
              <span 
                class="p-tag" 
                [ngClass]="item.tipoConceptoNombre?.toLowerCase().includes('deducci') ? 'p-tag-danger' : 'p-tag-success'">
                {{item.tipoConceptoNombre || '-'}}
              </span>
            </td>
            <td>{{item.periodoIdentificador || item.periodoIdentificacion}}</td>
            <td class="text-center">{{item.valorNovedad | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-center">{{item.fechaNovedad | date:'dd/MM/yyyy'}}</td>
            <td>
              <button 
                pButton 
                icon="pi pi-pencil" 
                class="p-button-rounded p-button-text p-button-warning mr-2"
                (click)="editPayrollItem(item)"
                pTooltip="Editar">
              </button>
              <button 
                pButton 
                icon="pi pi-trash" 
                class="p-button-rounded p-button-text p-button-danger"
                (click)="deletePayrollItem(item)"
                pTooltip="Eliminar">
              </button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center">
              <div *ngIf="!periodControl.value" class="p-3">
                <i class="pi pi-info-circle" style="font-size: 2rem; color: #6c757d;"></i>
                <p class="mt-2 mb-0" style="color: #6c757d;">
                  Seleccione un período para ver las novedades registradas
                </p>
              </div>
              <div *ngIf="periodControl.value" class="p-3">
                <i class="pi pi-inbox" style="font-size: 2rem; color: #6c757d;"></i>
                <p class="mt-2 mb-0" style="color: #6c757d;">
                  No hay novedades registradas para este período
                </p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-card>

  <!-- Sección 2: Proceso Nómina -->
  <p-card header="Proceso Nómina">
    <!-- Panel de Control -->
    <div class="grid">
      <div class="col-12 md:col-4">
        <label for="tipoProceso">Tipo de Proceso</label>
        <p-dropdown 
          id="tipoProceso"
          [(ngModel)]="selectedProceso"
          [options]="tiposProceso"
          placeholder="Seleccione tipo de proceso"
          styleClass="w-full"
          [disabled]="procesoEnEjecucion">
        </p-dropdown>
      </div>

      <div class="col-12 md:col-8 flex align-items-end gap-2">
        <button 
          pButton 
          label="Ejecutar Proceso" 
          icon="pi pi-play" 
          class="p-button-success"
          (click)="ejecutarProceso()"
          [disabled]="!clientControl.value || !periodControl.value || procesoEnEjecucion">
        </button>
        <button 
          pButton 
          label="Detener" 
          icon="pi pi-stop" 
          class="p-button-danger"
          (click)="detenerProceso()"
          [disabled]="!procesoEnEjecucion">
        </button>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mt-4" *ngIf="procesoEnEjecucion || procesoProgress > 0">
      <label>Estado del Proceso</label>
      <p-progressBar 
        [value]="procesoProgress" 
        [showValue]="true">
      </p-progressBar>
    </div>

    <!-- Resumen y Resultados -->
    <div class="mt-4" *ngIf="procesoResultados.length > 0">
      <!-- Panel de Resumen -->
      <div class="grid mb-3">
        <div class="col-12 md:col-3">
          <div class="summary-card">
            <i class="pi pi-users summary-icon"></i>
            <div>
              <div class="summary-label">Empleados a Liquidar</div>
              <div class="summary-value">{{totalEmpleados}}</div>
            </div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="summary-card">
            <i class="pi pi-dollar summary-icon"></i>
            <div>
              <div class="summary-label">Total a Pagar</div>
              <div class="summary-value">{{totalAPagar | currency:'COP':'symbol-narrow':'1.0-0'}}</div>
            </div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="summary-card warning">
            <i class="pi pi-exclamation-triangle summary-icon"></i>
            <div>
              <div class="summary-label">Advertencias</div>
              <div class="summary-value">{{empleadosConAdvertencias}}</div>
            </div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="summary-card error">
            <i class="pi pi-times-circle summary-icon"></i>
            <div>
              <div class="summary-label">Errores</div>
              <div class="summary-value">{{empleadosConErrores}}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de Descarga -->
      <div class="flex gap-2 mb-3">
        <button 
          pButton 
          label="Descargar PDF" 
          icon="pi pi-file-pdf" 
          class="p-button-danger p-button-outlined"
          (click)="descargarReporte('pdf')">
        </button>
        <button 
          pButton 
          label="Descargar Excel" 
          icon="pi pi-file-excel" 
          class="p-button-success p-button-outlined"
          (click)="descargarReporte('excel')">
        </button>
      </div>

      <!-- Tabla de Resultados -->
      <p-table 
        [value]="procesoResultados" 
        styleClass="p-datatable-sm"
        [paginator]="true"
        [rows]="10"
        responsiveLayout="scroll">
        
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 50px;" class="text-center">PDF</th>
            <th>Empleado</th>
            <th>Identificación</th>
            <!--<th class="text-right">Salario Base</th>-->
            <th class="text-right">Devengos</th>
            <th class="text-right">Adiciones</th>
            <th class="text-right">Deducciones</th>
            <th class="text-center">Días Trab.</th>
            <th class="text-center">Horas Trab.</th>
            <th class="text-center">Horas Extra</th>
            <th class="text-right">Salud</th>
            <th class="text-right">Pensión</th>
            <th class="text-right">Total a Pagar</th>
            <th>Novedades</th>
            <th class="text-center">Estado</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item>
          <tr>
            <td class="text-center">
              <button 
                pButton 
                type="button"
                icon="pi pi-file-pdf" 
                class="p-button-rounded p-button-danger p-button-text p-button-sm"
                (click)="generarColillaPDF(item)"
                pTooltip="Descargar colilla de nómina">
              </button>
            </td>
            <td>{{item.empleadoNombre}}</td>
            <td>{{item.identificacion}}</td>
            <!--<td class="text-right">{{item.salarioBase | currency:'COP':'symbol-narrow':'1.0-0'}}</td>-->
            <td class="text-right">{{item.devengos | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-right">{{item.adiciones | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-right">{{item.deducciones | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-center">{{item.diasTrabajados}}</td>
            <td class="text-center">{{item.totalHorasTrabajadas | number:'1.2-2'}}</td>
            <td class="text-center">{{item.totalHorasExtras | number:'1.2-2'}}</td>
            <td class="text-right">{{item.saludTrabajador | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-right">{{item.pensionTrabajador | currency:'COP':'symbol-narrow':'1.0-0'}}</td>
            <td class="text-right">
              <strong>{{item.totalPagar | currency:'COP':'symbol-narrow':'1.0-0'}}</strong>
            </td>
            <td>{{item.novedades}}</td>
            <td class="text-center">
              <p-tag 
                [severity]="getEstadoSeverity(item.estado)" 
                [value]="item.estado === 'success' ? 'OK' : item.estado === 'warning' ? 'Advertencia' : 'Error'">
              </p-tag>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="15" class="text-center">
              No hay resultados del proceso
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Mensaje inicial cuando no hay resultados -->
    <div *ngIf="procesoResultados.length === 0 && !procesoEnEjecucion">
      <p-message 
        severity="info" 
        text="Seleccione un tipo de proceso y haga clic en 'Ejecutar Proceso' para comenzar.">
      </p-message>
    </div>
  </p-card>

  <!-- Modal de Novedades -->
  <p-dialog 
    header="Agregar Novedades" 
    [(visible)]="displayNovedadDialog" 
    [modal]="true"
    [style]="{width: '70vw'}"
    [draggable]="false"
    [resizable]="false">
    
    <div class="novedad-content">
      <p-message 
        severity="info" 
        text="Ingrese las deducciones para los empleados seleccionados">
      </p-message>

      <!-- Período seleccionado -->
      <div class="periodo-info text-center mt-3 mb-3">
        <h4 class="periodo-title">Período: {{getSelectedPeriodName()}}</h4>
      </div>

      <div class="mt-3">
        <p-table 
          [value]="novedadesTemp" 
          styleClass="p-datatable-sm"
          responsiveLayout="scroll">
          
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 25%">Empleado</th>
              <th style="width: 30%">Concepto</th>
              <th style="width: 25%">Valor</th>
              <th style="width: 20%">Fecha Novedad</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <strong>{{item.employeeName}}</strong>
              </td>
              <td>
                <p-dropdown 
                  [(ngModel)]="item.conceptoId" 
                  [options]="conceptosAgrupados"
                  [group]="true"
                  placeholder="Seleccione concepto"
                  [filter]="true"
                  filterBy="label"
                  appendTo="body"
                  styleClass="w-full">
                  <ng-template let-group pTemplate="group">
                    <div class="flex align-items-center">
                      <strong>{{group.label}}</strong>
                    </div>
                  </ng-template>
                </p-dropdown>
              </td>
              <td>
                <p-inputNumber 
                  [(ngModel)]="item.valor" 
                  mode="currency" 
                  currency="COP" 
                  locale="es-CO"
                  [minFractionDigits]="0"
                  [maxFractionDigits]="0"
                  styleClass="w-full">
                </p-inputNumber>
              </td>
              <td>
                <p-calendar 
                  [(ngModel)]="item.fechaNovedad"
                  dateFormat="yy-mm-dd"
                  showIcon="true"
                  appendTo="body"
                  styleClass="w-full">
                </p-calendar>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
    
    <ng-template pTemplate="footer">
      <button 
        pButton 
        label="Cancelar" 
        icon="pi pi-times" 
        (click)="displayNovedadDialog = false" 
        class="p-button-secondary">
      </button>
      <button 
        pButton 
        label="Guardar Novedades" 
        icon="pi pi-check" 
        (click)="saveNovedades()">
      </button>
    </ng-template>
  </p-dialog>
</div>
